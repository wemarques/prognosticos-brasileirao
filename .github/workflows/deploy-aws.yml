name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - claude/fix-system-errors-01AK1ZbdXd1Pvipn2yyzNNcN
      - claude/frontend-review-improvements-01SLDqfrpQJaeBCaHmyLkkcU
  workflow_dispatch:  # Permite executar manualmente

env:
  AWS_REGION: us-east-1
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ubuntu
  EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
  DEPLOY_PATH: /home/ubuntu/prognosticos-brasileirao

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST 'echo "SSH connection successful"'

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'EOF'
            set -e

            echo "ðŸ“¦ Navigating to application directory..."
            cd ${{ env.DEPLOY_PATH }}

            echo "ðŸ”„ Pulling latest changes..."
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "ðŸ›‘ Stopping containers..."
            docker-compose down

            echo "ðŸ—ï¸ Building new images..."
            docker-compose build --no-cache

            echo "ðŸš€ Starting containers..."
            docker-compose up -d

            echo "â³ Waiting for application to start..."
            sleep 10

            echo "âœ… Checking container status..."
            docker-compose ps

            echo "ðŸ“Š Showing recent logs..."
            docker-compose logs --tail=50 app

            echo "âœ… Deploy completed successfully!"
          EOF

      - name: Health Check
        run: |
          sleep 5
          curl -f http://${{ secrets.EC2_HOST }}:8501/_stcore/health || exit 1
          echo "âœ… Application is healthy!"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deploy successful for branch ${{ github.ref_name }}"
          echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}:8501"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deploy failed for branch ${{ github.ref_name }}"
          echo "ðŸ“ Check logs for details"
